# Solar InfluxDB Bucket Schema

## Overview
This document provides a comprehensive overview of the data structure in the **solar** bucket, containing photovoltaic system monitoring data including inverter, battery, and energy production metrics.

---

## Data Structure Summary

### Measurements Available
- `solar` - Main solar system data

### Fields by Category
- **PV Panel Data**: 12 fields
- **Battery Data**: 6 fields
- **Energy Production**: 10 fields
- **Power Flow**: 8 fields
- **System Status**: 3 fields

### Tags
- No specific tags identified (likely using default `_` tag or no tags)

---

## Detailed Field Mapping

### PV Panel Measurements

#### PV String 1
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | PV1EnergyToday | Energy generated by PV string 1 today | kWh |
| solar | PV1EnergyTotal | Total energy generated by PV string 1 | kWh |
| solar | PV1InputCurrent | Current from PV string 1 | A |
| solar | PV1InputPower | Power from PV string 1 | W |
| solar | PV1Voltage | Voltage from PV string 1 | V |

#### PV String 2
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | PV2EnergyToday | Energy generated by PV string 2 today | kWh |
| solar | PV2EnergyTotal | Total energy generated by PV string 2 | kWh |
| solar | PV2InputCurrent | Current from PV string 2 | A |
| solar | PV2InputPower | Power from PV string 2 | W |
| solar | PV2Voltage | Voltage from PV string 2 | V |

#### Combined PV Data
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | PVEnergyTotal | Total energy from all PV strings | kWh |
| solar | TodayGenerateEnergy | Total energy generated today | kWh |
| solar | TotalGenerateEnergy | Total energy generated (lifetime) | kWh |

### Battery System

| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | BatteryState | Battery operational state | - |
| solar | BatteryTemperature | Battery temperature | °C |
| solar | BatteryVoltage | Battery voltage | V |
| solar | SOC | State of Charge (battery level) | % |
| solar | ChargeEnergyToday | Energy charged to battery today | kWh |
| solar | ChargeEnergyTotal | Total energy charged to battery | kWh |
| solar | ChargePower | Current charging power | W |
| solar | DischargeEnergyToday | Energy discharged from battery today | kWh |
| solar | DischargeEnergyTotal | Total energy discharged from battery | kWh |
| solar | DischargePower | Current discharge power | W |

### Power Flow & Grid Interaction

#### Power to Grid
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | ACPowerToGrid | Current AC power sent to grid | W |
| solar | ACPowerToGridTotal | Total AC power sent to grid | kWh |
| solar | EnergyToGridToday | Energy sent to grid today | kWh |
| solar | EnergyToGridTotal | Total energy sent to grid | kWh |

#### Power to User/Load
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | ACPowerToUser | Current AC power to user loads | W |
| solar | ACPowerToUserTotal | Total AC power to user loads | kWh |
| solar | EnergyToUserToday | Energy to user loads today | kWh |
| solar | EnergyToUserTotal | Total energy to user loads | kWh |

#### Local Load
| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | INVPowerToLocalLoad | Inverter power to local load | W |
| solar | INVPowerToLocalLoadTotal | Total inverter power to local load | kWh |
| solar | LocalLoadEnergyToday | Local load energy today | kWh |
| solar | LocalLoadEnergyTotal | Total local load energy | kWh |

### System Status & Performance

| Measurement | Field | Description | Unit |
|-------------|-------|-------------|------|
| solar | InputPower | Total input power to system | W |
| solar | OutputPower | Total output power from system | W |
| solar | InverterStatus | Inverter operational status | - |
| solar | InverterTemperature | Inverter temperature | °C |

---

## Query Examples

### Current System Performance:
```flux
from(bucket: "solar")
|> range(start: -1h)
|> filter(fn: (r) => r._measurement == "solar")
|> filter(fn: (r) => r._field =~ /^(PV1InputPower|PV2InputPower|ChargePower|DischargePower|ACPowerToGrid|ACPowerToUser)$/)
|> last()
```

### Daily Energy Production Summary:
```flux
from(bucket: "solar")
|> range(start: today())
|> filter(fn: (r) => r._measurement == "solar")
|> filter(fn: (r) => r._field =~ /Today$/)
|> last()
```

### Battery Status Dashboard:
```flux
from(bucket: "solar")
|> range(start: -1h)
|> filter(fn: (r) => r._measurement == "solar")
|> filter(fn: (r) => r._field =~ /^(SOC|BatteryVoltage|BatteryTemperature|BatteryState|ChargePower|DischargePower)$/)
|> last()
```

### PV String Performance Comparison:
```flux
from(bucket: "solar")
|> range(start: -24h)
|> filter(fn: (r) => r._measurement == "solar")
|> filter(fn: (r) => r._field =~ /^(PV1InputPower|PV2InputPower)$/)
|> aggregateWindow(every: 1h, fn: mean, createEmpty: false)
```

### Energy Flow Analysis:
```flux
from(bucket: "solar")
|> range(start: -24h)
|> filter(fn: (r) => r._measurement == "solar")
|> filter(fn: (r) => r._field =~ /^(TodayGenerateEnergy|EnergyToGridToday|EnergyToUserToday|ChargeEnergyToday|DischargeEnergyToday)$/)
|> aggregateWindow(every: 1h, fn: mean, createEmpty: false)
```

### System Efficiency Calculation:
```flux
// Calculate daily efficiency: (Energy to User + Energy to Grid) / Total Generated
generation = from(bucket: "solar")
|> range(start: today())
|> filter(fn: (r) => r._measurement == "solar" and r._field == "TodayGenerateEnergy")
|> last()

usage = from(bucket: "solar")
|> range(start: today())
|> filter(fn: (r) => r._measurement == "solar" and r._field =~ /^(EnergyToGridToday|EnergyToUserToday)$/)
|> last()
|> sum(column: "_value")
```

---

## Integration Opportunities

### With Electricity Pricing:
```flux
// Calculate savings based on grid energy vs solar production
electricityPrice = from(bucket: "ote_prices")
|> range(start: -24h)
|> filter(fn: (r) => r._field == "price_czk_kwh")

solarToGrid = from(bucket: "solar")
|> range(start: -24h)
|> filter(fn: (r) => r._field == "EnergyToGridToday")
```

---

## Key Performance Indicators (KPIs)

### Daily Metrics:
- **Total Generation**: `TodayGenerateEnergy`
- **Self Consumption**: `EnergyToUserToday`
- **Grid Export**: `EnergyToGridToday`
- **Battery Cycling**: `ChargeEnergyToday` + `DischargeEnergyToday`

### Real-time Monitoring:
- **Current Production**: `PV1InputPower` + `PV2InputPower`
- **Battery Level**: `SOC`
- **Grid Export/Import**: `ACPowerToGrid` vs `ACPowerToUser`
- **System Health**: `InverterStatus`, `InverterTemperature`, `BatteryTemperature`

### Efficiency Metrics:
- **String Balance**: Compare `PV1InputPower` vs `PV2InputPower`
- **Inverter Efficiency**: `OutputPower` / `InputPower`
- **Self-Consumption Rate**: `EnergyToUserToday` / `TodayGenerateEnergy`

---

## Summary Statistics
- **Total Fields**: 40
- **PV Strings**: 2 monitored strings
- **Battery System**: Full monitoring (SOC, power, energy, temperature)
- **Energy Flows**: 4 directions (Grid, User, Charge, Discharge)
- **System Monitoring**: Inverter status and temperatures